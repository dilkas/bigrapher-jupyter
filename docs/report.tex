\documentclass{article}
\usepackage[UKenglish]{babel}
\usepackage[UKenglish]{isodate}
\usepackage[T1]{fontenc}
\usepackage{url}
\usepackage{textcomp}
\usepackage{upquote}
\usepackage{listings}
\lstset{upquote=true}

\author{Paulius Dilkas}
\title{Towards User-Friendly Bigraphs}

\begin{document}
\maketitle

\begin{abstract}
  We adapt an OCaml Jupyter kernel to support BigraphER.
\end{abstract}

\section{Introduction}

\subsection{Jupyter}

Project Jupyter \cite{website:jupyter}, notebook \cite{website:docs}, kernel,
OCaml kernel\footnote{\url{https://github.com/akabe/ocaml-jupyter}}, cell.

\subsection{Bigraphs and BigraphER}

Bigraphs,
BigraphER\footnote{\url{http://www.dcs.gla.ac.uk/~michele/bigrapher.html}}
\cite{Sevegnani2016}

begin-end block, stochastic and non-stochastic reaction rules

Goals: convenience of use, supporting a similar workflow to how Jupyter works
with Python, not surprising the user with unexpected behaviour.

\section{Assumptions}

\begin{itemize}
\item Keywords \texttt{big}, \texttt{react}, \texttt{begin} start the beginning
  of line.
\item Single spaces or no spaces.
\end{itemize}

\section{Features}

\begin{itemize}
\item Variables defined in one cell persist to the next (unless the cell
  contains a begin-end block or fails to run). This is done in the same order as
  the cells are run, including running the same cell multiple times.
\item The output of each cell corresponds to everything defined in that cell
  (bigraphs and reaction rules): name first, then diagrams.
\item Reaction rules are visualised in an HTML table, connecting the diagrams
  side-by-side.
\item Both stochastic and non-stochastic rules are supported, as long as they
  are not in the same cell.
\item BigraphER API can be called from an OCaml cell. In order to make it work,
  two lines must be added to \texttt{~/.ocamlinit}:
  \begin{lstlisting}
#use "topfind";;
#require "bigraph";;
  \end{lstlisting}
  Then... %TODO: example
\item Auto-complete and integrated documentation for BigraphER OCaml API (and
  other OCaml code) using Merlin.
\item The two BigraphER-specific magics can be used at the same time, provided
  they are on the first two lines, in either order.
\end{itemize}

\subsection{Magics}

The IPython kernel defines a number of magics, i.e., additional commands that
are not part of the underlying language (Python) \cite{website:magic}.
Similarly, we define several magics for our kernel, however, their use is
significantly restricted:
\begin{itemize}
\item A magic occupies its own line.
\item All magics are listed before any other code. For example, when using two
  magics, they must be on lines one and two.
\item Magics must not be indented.
\end{itemize}

The first magic allows full backwards compatibility with the OCaml kernel. If
the first line of a cell reads \texttt{\%ocaml}, subsequent lines will be
interpreted as OCaml code, including Merlin-based autocomplete and documentation
tooltips as well as Archimedes plots.

BigraphER's output is hidden by default, since typical Jupyter workflow is
likely to cause numerous warnings about multiple definitions of the same
variable. However, full output can be enabled with the magic \texttt{\%output}.

Since in most cases code from previously run cells is prepended to the current
cell before evaluation, and multiple control (\texttt{ctrl}) definitions can
cause errors rather than warnings, \texttt{\%clear} magic can be used to empty
the buffer before evaluating the current cell, thus allowing the user to
redefine any variables with no issues.

\section{Implementation}

\begin{itemize}
\item Separate buffers are used for OCaml and BigraphER code, allowing the user
  to seamlessly mix the two languages, as if they were in different notebooks.
\item Code from buffer is written to a file, BigraphER is run to generate
  images, file is deleted.
\item Directory permissions are $700$.
\item \texttt{react} keyword is ignored if it's not at the start of a line.
\item All images are saved in a directory \texttt{jupyter-images}, with a
  subdirectory for each cell. If a subdirectory doesn't exist, it is created.
  Otherwise, its contents are cleared before the new images are added. Stale
  directories are not deleted.
\end{itemize}

When evaluating a cell, we look for a begin-end block in a top-down
fashion (but ignoring the buffer).
\begin{itemize}
\item In case the model turns out to be non-stochastic (starts with
  \texttt{begin brs}), no additional work needs to be done.
\item If we find a stochastic (\texttt{sbrs}) model, we must remove all
  non-stochastic reaction rules from both the buffer and the cell.
\item If such a block is not found, a dummy \texttt{brs} block is generated
  for the purpose of running BigraphER and generating the required images. The
  dummy \texttt{begin}-\texttt{end} block has the form:
  \begin{lstlisting}
ctrl C = 0;
big b = C.1;
react r = b --> b;
begin brs
  init b;
  rules = [{r}];
  preds = {b};
end
\end{lstlisting}
\texttt{C}, \texttt{b}, and \texttt{r} are randomly generated words,
distinct from each other and other variables defined in the cell or buffer.
The words are generated by adding random letters until the constructed
string becomes unique. For simplicity of implementation, \texttt{C} always
starts with a capital letter C.
\end{itemize}

\section{Conclusion}

\bibliographystyle{plain}
\bibliography{references}
\end{document}